# DuoCalculator Course Data Scraper
# Runs weekly to fetch and update course data from duolingodata.com
# 
# Features:
# - Weekly cron schedule (Sunday 3 AM UTC)
# - Manual trigger with full-refresh option
# - Validation gates commits (error threshold check)
# - Rollback support via data-stable tag
# - Automatic issue creation on failure

name: Scrape Duolingo Course Data

on:
  schedule:
    # Every Sunday at 3:00 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      full_refresh:
        description: 'Force full refresh of all courses'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      validation_passed: ${{ steps.validate.outputs.passed }}
      validation_errors: ${{ steps.validate.outputs.error_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/scraper/package-lock.json

      - name: Install scraper dependencies
        working-directory: scripts/scraper
        run: npm ci || npm install

      - name: Run scraper
        id: scrape
        working-directory: scripts/scraper
        run: |
          node index.js \
            --output ../../data \
            --rate-limit 500 \
            --full-refresh ${{ inputs.full_refresh || 'false' }}
        env:
          USER_AGENT: 'duocalculator-scraper/1.0 (+https://github.com/${{ github.repository }})'

      - name: Validate scraped data
        id: validate
        working-directory: scripts/scraper
        run: |
          node validate.js --data ../../data --error-threshold 10
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "error_count=0" >> $GITHUB_OUTPUT

      - name: Rollback on validation failure
        if: failure() && steps.validate.outcome == 'failure'
        run: |
          echo "âŒ Validation failed, attempting rollback to data-stable branch..."
          git fetch origin data-stable --depth=1 2>/dev/null || true
          git checkout origin/data-stable -- data/ 2>/dev/null || {
            echo "âš ï¸  No data-stable branch found, keeping previous data"
            git checkout HEAD -- data/ 2>/dev/null || true
          }

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet data/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ðŸ“­ No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¬ Changes detected:"
            git diff --stat data/
          fi

      - name: Commit and push
        if: steps.check.outputs.changed == 'true' && steps.validate.outputs.passed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage data files
          git add data/
          
          # Extract stats for commit message
          COURSE_COUNT=$(jq -r '.courses | length' data/courses.json 2>/dev/null || echo "?")
          TIMESTAMP=$(jq -r '.scrapedAt' data/manifest.json 2>/dev/null || echo "?")
          ERROR_COUNT=$(jq -r '.failedCourses | length' data/manifest.json 2>/dev/null || echo "0")
          DETAIL_COUNT=$(jq -r '.detailCount' data/manifest.json 2>/dev/null || echo "?")
          
          # Create commit with summary
          git commit -m "chore(data): update course data
          
          - Courses: ${COURSE_COUNT}
          - Details: ${DETAIL_COUNT}
          - Scraped: ${TIMESTAMP}
          - Failed courses: ${ERROR_COUNT}
          - Validation: âœ… PASSED
          - Triggered by: ${{ github.event_name }}"
          
          # Create/update data-stable tag for rollback support
          git tag -f data-stable
          
          # Push commit and tag
          git push
          git push origin data-stable --force

      - name: Skip commit on validation failure
        if: steps.validate.outputs.passed != 'true'
        run: |
          echo "âŒ Data validation failed (error rate >10%). Skipping commit."
          echo "Previous stable data retained. Manual review required."
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Scrape Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f data/manifest.json ]; then
            SCRAPED_AT=$(jq -r '.scrapedAt' data/manifest.json)
            COURSE_COUNT=$(jq -r '.courseCount' data/manifest.json)
            DETAIL_COUNT=$(jq -r '.detailCount' data/manifest.json)
            FAILED_COUNT=$(jq -r '.failedCourses | length' data/manifest.json)
            DURATION_MS=$(jq -r '.scrapeDurationMs' data/manifest.json)
            DURATION_SEC=$(echo "scale=1; $DURATION_MS / 1000" | bc 2>/dev/null || echo "?")
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“… Scraped at | $SCRAPED_AT |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“š Courses | $COURSE_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“– Details scraped | $DETAIL_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed courses | $FAILED_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Duration | ${DURATION_SEC}s |" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Validation | ${{ steps.validate.outputs.passed == 'true' && 'PASSED' || 'FAILED' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“ Changes committed | ${{ steps.check.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No manifest.json found - scraper may have failed early." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Full refresh:** ${{ inputs.full_refresh || 'false' }}" >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    needs: scrape
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Scraper failed: ${new Date().toISOString().split('T')[0]}`;
            const body = `## Scraper Failure Report

            The weekly course data scrape has failed.

            ### Details
            - **Workflow run:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Triggered by:** \`${{ github.event_name }}\`
            - **Branch:** \`${{ github.ref_name }}\`

            ### Status
            - **Validation passed:** \`${{ needs.scrape.outputs.validation_passed || 'unknown' }}\`
            - **Error count:** \`${{ needs.scrape.outputs.validation_errors || 'unknown' }}\`

            ### Action Required
            1. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
            2. Previous stable data has been retained
            3. Re-run manually if needed: \`Actions > Scrape Duolingo Course Data > Run workflow\`

            ---
            *This issue was automatically created by the scraper workflow.*
            `;

            // Check for existing open issue with same label
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'scraper-failure',
              state: 'open',
              per_page: 1
            });

            if (existingIssues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['scraper-failure', 'automated', 'bug']
              });
              console.log('Created new failure issue');
            } else {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues[0].number,
                body: `### Another failure on ${new Date().toISOString().split('T')[0]}

                [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                
                Validation passed: \`${{ needs.scrape.outputs.validation_passed || 'unknown' }}\``
              });
              console.log('Commented on existing issue #' + existingIssues[0].number);
            }
